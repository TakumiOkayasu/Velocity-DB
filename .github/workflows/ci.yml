name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Default permissions (read-only)
permissions:
  contents: read

jobs:
  # C++ lint (parallel with frontend lint)
  lint-cpp:
    name: Lint C++
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install LLVM 21 (clang-format)
        run: |
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
          echo "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-21 main" | sudo tee /etc/apt/sources.list.d/llvm.list
          sudo apt-get update
          sudo apt-get install -y clang-format-21
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-21 100

      - name: Normalize line endings to LF
        run: |
          find backend -name '*.cpp' -o -name '*.h' | xargs sed -i 's/\r$//'

      - name: Remove BOM from files
        run: |
          find backend -name '*.cpp' -o -name '*.h' | while read file; do
            sed -i '1s/^\xEF\xBB\xBF//' "$file"
          done

      - name: Check C++ formatting
        run: |
          find backend -name '*.cpp' -o -name '*.h' | xargs -P 4 -I {} clang-format --style=file --dry-run --Werror {}

  # Frontend lint (parallel with C++ lint)
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Cache Bun dependencies
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        working-directory: frontend
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            bun install
          else
            bun install --frozen-lockfile
          fi

      - name: Lint and Type Check (parallel)
        working-directory: frontend
        run: |
          bun run lint &
          LINT_PID=$!
          bun run typecheck &
          TYPECHECK_PID=$!
          wait $LINT_PID
          wait $TYPECHECK_PID

  # Compatibility job for branch protection rules
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [lint-cpp, lint-frontend]
    steps:
      - run: echo "All lint checks passed"

  # Frontend build and test (depends on frontend lint only)
  build-frontend:
    name: Build & Test Frontend
    runs-on: ubuntu-latest
    needs: lint-frontend
    steps:
      - uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.4

      - name: Cache Bun dependencies
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('frontend/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        working-directory: frontend
        run: |
          if [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            bun install
          else
            bun install --frozen-lockfile
          fi

      - name: Build and Test (parallel)
        working-directory: frontend
        run: |
          bun run build &
          BUILD_PID=$!
          bun run test --run &
          TEST_PID=$!
          wait $BUILD_PID
          wait $TEST_PID

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

  # Backend build on Windows (depends on C++ lint only)
  # Runs on: main branch push OR PR with 'test-backend' label
  build-backend:
    name: Build & Test Backend
    runs-on: windows-latest
    needs: lint-cpp
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'test-backend'))
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          allow-prereleases: true

      - name: Normalize line endings (CRLF)
        run: python scripts/convert_eol.py crlf

      - name: Setup MSVC Developer Environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja and ccache
        run: choco install ninja ccache -y

      - name: Setup ccache
        run: |
          echo "CC=cl.exe" >> $env:GITHUB_ENV
          echo "CXX=cl.exe" >> $env:GITHUB_ENV
          echo "CMAKE_CXX_COMPILER_LAUNCHER=ccache" >> $env:GITHUB_ENV
          echo "CMAKE_C_COMPILER_LAUNCHER=ccache" >> $env:GITHUB_ENV

      - name: Cache ccache
        uses: actions/cache@v5
        with:
          path: ~\.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('**/*.cpp', '**/*.h') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Cache CMake build
        uses: actions/cache@v5
        with:
          path: |
            build/_deps
            build/third_party
            build/CMakeCache.txt
            build/CMakeFiles
            build/**/*.dir
          key: cmake-v2-ninja-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'backend/CMakeLists.txt', 'third_party/CMakeLists.txt') }}
          restore-keys: |
            cmake-v2-ninja-${{ runner.os }}-

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_TESTS=ON `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache

      - name: Build (parallel)
        run: cmake --build build --config Release --parallel

      - name: Run Tests (parallel)
        run: ctest --test-dir build --output-on-failure --parallel

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: backend-build
          path: build/Release/
          retention-days: 7

  # Package - only when backend is built (main branch only)
  package:
    name: Package Application
    runs-on: windows-latest
    needs: [build-frontend, build-backend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v6

      - name: Download frontend build
        uses: actions/download-artifact@v7
        with:
          name: frontend-build
          path: package/frontend

      - name: Download backend build
        uses: actions/download-artifact@v7
        with:
          name: backend-build
          path: package

      - name: List package contents
        run: |
          echo "Package contents:"
          Get-ChildItem -Recurse package | ForEach-Object { $_.FullName }

      - name: Upload packaged application
        uses: actions/upload-artifact@v6
        with:
          name: Velocity-DB-windows-x64
          path: package/
          retention-days: 30

  # Final status check
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint-cpp, lint-frontend, build-frontend]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint-cpp.result }}" != "success" ]] || \
             [[ "${{ needs.lint-frontend.result }}" != "success" ]] || \
             [[ "${{ needs.build-frontend.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All required jobs passed!"
