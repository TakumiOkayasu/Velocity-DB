select u.user_id,u.username,u.email,u.created_at,u.last_login,case when u.status='active' and u.premium_member=1 then 'プレミアム会員' when u.status='active' then 'アクティブ' when u.status='pending' then '保留中' else '無効' end as status_label,o.order_id,o.order_date,o.total_amount,oi.product_name,oi.quantity,oi.unit_price,p.category_name,(select count(*) from reviews r where r.user_id=u.user_id and r.rating>=4) as good_reviews from users u inner join orders o on u.user_id=o.user_id left join order_items oi on o.order_id=oi.order_id left join products p on oi.product_id=p.product_id left join categories c on p.category_id=c.category_id where u.created_at>='2024-01-01' and u.created_at<='2024-12-31' and u.status in ('active','pending') and (o.total_amount>10000 or u.premium_member=1) and p.category_id in (select category_id from categories where parent_id=5 and active=1) group by u.user_id,u.username,u.email,u.created_at,u.last_login,u.status,u.premium_member,o.order_id,o.order_date,o.total_amount,oi.product_name,oi.quantity,oi.unit_price,p.category_name having count(distinct oi.product_id)>=3 and sum(oi.quantity*oi.unit_price)>5000 order by o.order_date desc,u.username asc,o.total_amount desc
