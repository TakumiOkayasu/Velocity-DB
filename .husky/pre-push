#!/bin/sh

echo "Running pre-push checks..."

# Check for uncommitted changes before lint (to detect if lint modifies files)
DIRTY_BEFORE=$(git status --porcelain)

# Run lint + format first (fast)
cmd.exe //c "scripts\\run-lint.bat"
if [ $? -ne 0 ]; then
    echo ""
    echo "=========================================="
    echo "Lint/format failed!"
    echo "Fix the errors above before pushing."
    echo "=========================================="
    exit 1
fi

# Check if lint/format modified any files
DIRTY_AFTER=$(git status --porcelain)
if [ "$DIRTY_BEFORE" != "$DIRTY_AFTER" ]; then
    echo ""
    echo "=========================================="
    echo "Lint/format modified files!"
    echo "Please commit the changes and try again:"
    echo ""
    git status --short
    echo ""
    echo "Run: git add -A && git commit --amend --no-edit"
    echo "=========================================="
    exit 1
fi

# Run frontend typecheck and build
echo ""
echo "[Frontend] Running typecheck..."
cd frontend
npm run typecheck
if [ $? -ne 0 ]; then
    echo ""
    echo "=========================================="
    echo "Frontend typecheck failed!"
    echo "Fix the errors above before pushing."
    echo "=========================================="
    exit 1
fi

echo ""
echo "[Frontend] Running build..."
npm run build
if [ $? -ne 0 ]; then
    echo ""
    echo "=========================================="
    echo "Frontend build failed!"
    echo "Fix the errors above before pushing."
    echo "=========================================="
    exit 1
fi
cd ..

# Run C++ build (auto-detect Visual Studio)
echo ""
echo "[C++] Running build..."
cmd.exe //c "scripts\\cpp-build.bat"
if [ $? -ne 0 ]; then
    echo ""
    echo "=========================================="
    echo "C++ build failed!"
    echo "Fix the errors above before pushing."
    echo "=========================================="
    exit 1
fi

echo ""
echo "Pre-push checks passed!"
