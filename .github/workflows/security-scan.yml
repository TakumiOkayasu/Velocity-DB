name: Security Scan

on:
  schedule:
    # Run daily at JST 00:00 (UTC 15:00)
    - cron: '0 15 * * *'
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Semgrep: Fast pattern-based security scanning
  semgrep:
    name: Semgrep Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep Scan
        run: |
          semgrep scan \
            --config=auto \
            --config=p/security-audit \
            --config=p/owasp-top-ten \
            --json \
            --output=semgrep-results.json \
            --exclude='node_modules' \
            --exclude='build' \
            --exclude='dist' \
            --exclude='third_party' \
            . || true

      - name: Create Issues from Semgrep Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Check if results file exists
            if (!fs.existsSync('semgrep-results.json')) {
              console.log('No Semgrep results file found');
              return;
            }

            const results = JSON.parse(fs.readFileSync('semgrep-results.json', 'utf8'));
            const findings = results.results || [];

            console.log(`Found ${findings.length} issues`);

            // Get existing open issues with semgrep label
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,semgrep',
              per_page: 100
            });

            const existingTitles = new Set(existingIssues.data.map(i => i.title));

            // Filter to high/medium severity only to reduce noise
            const significantFindings = findings.filter(f => {
              const severity = (f.extra?.severity || 'INFO').toUpperCase();
              return ['ERROR', 'WARNING', 'HIGH', 'MEDIUM', 'CRITICAL'].includes(severity);
            });

            console.log(`${significantFindings.length} significant findings to process`);

            for (const finding of significantFindings) {
              const ruleId = finding.check_id || 'unknown';
              const filePath = finding.path || 'unknown';
              const line = finding.start?.line || 0;

              // Create unique title for deduplication
              const title = `[Semgrep] ${ruleId.split('.').pop()} in ${filePath}:${line}`;

              // Skip if issue already exists
              if (existingTitles.has(title)) {
                console.log(`Skipping duplicate: ${title}`);
                continue;
              }

              const severity = (finding.extra?.severity || 'medium').toLowerCase();
              const message = finding.extra?.message || 'No description available';
              const codeSnippet = finding.extra?.lines || '';

              const body = `## Security Issue Detected by Semgrep

            **Rule ID:** \`${ruleId}\`
            **Severity:** ${severity}
            **File:** \`${filePath}\`
            **Line:** ${line}

            ### Description
            ${message}

            ### Affected Code
            \`\`\`
            ${codeSnippet}
            \`\`\`

            ### References
            ${(finding.extra?.metadata?.references || []).map(r => `- ${r}`).join('\n') || 'None'}

            ---
            *This issue was automatically created by the security scan workflow.*
            `;

              // Determine priority label based on severity
              const priorityLabel = severity === 'high' || severity === 'critical' || severity === 'error'
                ? 'priority:high'
                : 'priority:medium';

              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['security', 'semgrep', priorityLabel]
                });
                console.log(`Created issue: ${title}`);
              } catch (error) {
                console.error(`Failed to create issue: ${error.message}`);
              }
            }

  # CodeQL: Deep semantic analysis
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']
        # Note: C++ analysis requires Windows SDK headers
        # Full C++ analysis runs on Windows in separate workflow if needed

    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Setup Bun (for TypeScript)
        if: matrix.language == 'javascript-typescript'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install frontend dependencies
        if: matrix.language == 'javascript-typescript'
        working-directory: frontend
        run: bun install --frozen-lockfile

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
        # Allow workflow to continue even if upload fails (Code Scanning not enabled)
        continue-on-error: true

  # Summary job
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [semgrep, codeql]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "=== Security Scan Summary ==="
          echo "Semgrep: ${{ needs.semgrep.result }}"
          echo "CodeQL: ${{ needs.codeql.result }}"

          if [[ "${{ needs.semgrep.result }}" == "failure" ]] || \
             [[ "${{ needs.codeql.result }}" == "failure" ]]; then
            echo "One or more scans failed - check logs for details"
            exit 1
          fi

          echo "All security scans completed successfully"
